"use strict";function JsonValidator(a,b,c,d){c=c||a,d=d||[];var e;if(a.$ref&&(a=this.resolveReference(a.$ref,c,d)),a.allOf&&(a=_.defaults.apply(this,_.map(a.allOf,function(a){return a.$ref?this.resolveReference(a.$ref,c,d):a},this))),a.enum)e=JsonEnum;else switch(a.type){case"array":e=JsonArray;break;case"boolean":e=JsonBoolean;break;case"integer":case"number":e=JsonNumber;break;case"null":e=JsonNull;break;case"object":e=JsonObject;break;case"string":e="text"===a.display?JsonText:JsonString}return new e(a,b,c,d)}function JsonEnum(a,b){this.initialize(a,b)}function JsonArray(a,b,c,d){this.initialize(a,b,c,d)}function JsonObject(a,b,c,d){this.initialize(a,b,c,d)}function JsonString(a,b,c,d){this.initialize(a,b,c,d)}function JsonText(a,b,c,d){this.initialize(a,b,c,d)}function JsonBoolean(a,b,c,d){this.initialize(a,b,c,d)}function JsonNull(a){this.schema=a,this.errors=[]}function JsonNumber(a,b,c,d){this.initialize(a,b,c,d)}_.extend(JsonValidator.prototype,{validations:{},validate:function(){_.each(this.validations,function(a,b){if(this.schema.hasOwnProperty(b)){var c=a(this.schema[b],this.value());c&&this.errors.push(c)}},this)},valid:function(){return!this.errors.length},value:function(){return this.data},initialize:function(a,b,c,d){this.schema=a,this.root=c,this.fragments=d,this.setData(void 0===b?a.default:b)},setData:function(a){return this.data=a,this.errors=[],this.validate(),this},resolveReference:function(a,b){var c=a.split("#")[1],d=c.split("/").slice(1);return _.reduce(d,function(a,b){return a[b]},b)},inline:!0}),_.extend(JsonEnum.prototype,JsonValidator.prototype,{valid:function(){return-1!==this.schema.enum.indexOf(this.value())},inline:!1}),_.extend(JsonArray.prototype,JsonValidator.prototype,{validations:{minItems:function(a,b){return b.length<a?"Must have at least "+a+" items":void 0},maxItems:function(a,b){return b.length>a?"Must have at most "+a+" items":void 0}},removeItem:function(a){var b=this.value();b.splice(a,1),this.setData(b)},setData:function(a){if(this.errors=[],this.items=[],a=a||[],"array"==typeof this.schema.items)for(var b=0;b<a.length;b++){var c=this.fragments.concat([b]);this.items[b]=new JsonValidator(this.schema.items[b],a[b],this.root,c)}else if("object"==typeof this.schema.items){var d=a.length;this.schema.hasOwnProperty("minItems")&&this.schema.minItems>d&&(d=this.schema.minItems);for(var b=0;d>b;b++){var c=this.fragments.concat([b]);this.items[b]=new JsonValidator(this.schema.items,a[b],this.root,c)}}return this.validate(),this},value:function(){return _.map(this.items,function(a){return a.value()})},valid:function(){return JsonValidator.prototype.valid.call(this)&&_.every(this.items,function(a){return a.valid()})},inline:!1}),_.extend(JsonObject.prototype,JsonValidator.prototype,{setData:function(a){return this.errors=[],this.properties={},a=a||{},_.each(a,function(a,b){var c;if(this.schema.properties&&this.schema.properties.hasOwnProperty(b)?c=this.schema.properties[b]:this.schema.additionalProperties&&(c=this.schema.additionalProperties),c){var d=this.fragments.concat([b]);this.properties[b]=new JsonValidator(c,a,this.root,d)}else this.errors.push("Unknown property: "+b)},this),_.each(this.schema.required||[],function(b){if(!a.hasOwnProperty(b)){var c=this.schema.properties[b],d=this.fragments.concat([b]);this.properties[b]=new JsonValidator(c,void 0,this.root,d)}},this),this},value:function(){var a={};return _.each(this.properties,function(b,c){a[c]=b.value()}),a},valid:function(){return JsonValidator.prototype.valid.call(this)&&_.every(this.properties,function(a){return a.valid()})},required:function(a){return this.schema.required&&-1!=this.schema.required.indexOf(a)},inline:!1}),_.extend(JsonString.prototype,JsonValidator.prototype,{validations:{minLength:function(a,b){return b.length<a?"Must be at least "+a+" characters":void 0},maxLength:function(a,b){return b.length>a?"Must be at most "+a+" characters":void 0},pattern:function(a,b){return new RegExp(a).test(b)?void 0:"Must match pattern: "+a}},setData:function(a){return JsonValidator.prototype.setData.call(this,a||"")}}),_.extend(JsonText.prototype,JsonString.prototype,{inline:!1}),_.extend(JsonBoolean.prototype,JsonValidator.prototype,{setData:function(a){return JsonValidator.prototype.setData.call(this,a||!1)}}),_.extend(JsonNull.prototype,{setData:function(){return this},valid:function(){return!0},value:function(){return null},inline:!0}),_.extend(JsonNumber.prototype,JsonValidator.prototype,{validations:{multipleOf:function(a,b){return b%a!==0?"Must be a multiple of "+a:void 0},maximum:function(a,b){return b>a?"Must be less than or equal to "+a:void 0},minimum:function(a,b){return a>b?"Must be greater than or equal to "+a:void 0},exclusiveMaximum:function(a,b){return b>=a?"Must be less than "+a:void 0},exclusiveMinimum:function(a,b){return a>=b?"Must be greater than "+a:void 0}},validate:function(){"number"!=typeof this.value()?this.errors.push("Must be a number"):"integer"===this.schema.type&&this.value()%1!==0?this.errors.push("Must be an integer"):JsonValidator.prototype.validate.call(this)}}),function(){JsonString.prototype.view=React.createClass({handleChange:function(a){this.props.validator.setData(a.target.value),this.props.onChange(this.props.validator)},render:function(){return React.DOM.input({onChange:this.handleChange,type:"text",value:this.props.validator.value()})}}),JsonText.prototype.view=React.createClass({handleChange:function(a){this.props.validator.setData(a.target.value),this.props.onChange(this.props.validator)},render:function(){return React.DOM.textarea({onChange:this.handleChange,type:"text",value:this.props.validator.value()})}}),JsonNumber.prototype.view=React.createClass({handleChange:function(a){var b,c=a.target.value;c&&isFinite(c)&&(b=parseFloat(c)),this.props.validator.setData(b),this.props.onChange(this.props.validator)},render:function(){return React.DOM.input({onChange:this.handleChange,type:"text",value:this.props.validator.value()})}}),JsonEnum.prototype.view=React.createClass({handleChange:function(a){this.props.validator.setData(a),this.props.onChange(this.props.validator)},_inputs:function(){var a=Math.floor(1e4*Math.random());return _.map(this.props.validator.schema.enum,function(b){return React.DOM.div({className:"json-form-row"},React.DOM.div({className:"json-form-control"},React.DOM.input({type:"radio",name:a,checked:this.props.validator.value()==b,onChange:this.handleChange.bind(this,b)}," ",b)))},this)},render:function(){return React.DOM.div({className:"json-enum"},this._inputs())}}),JsonArray.prototype.view=React.createClass({handleNewItem:function(){var a=this.props.validator,b=a.value();b.push(void 0),a.setData(b),this.props.onChange(a)},handleRemoveItem:function(a){this.props.validator.removeItem(a),this.props.onChange(this.props.validator)},handleChangeItem:function(a,b){this.props.validator.items[a]=b,this.props.onChange(this.props.validator)},_items:function(){return _.map(this.props.validator.items,function(b,c){var d=b.view;return a({property:c,onRemove:this.handleRemoveItem.bind(this,c)},d({validator:b,onChange:this.handleChangeItem.bind(this,c)}))},this)},_addItemButton:function(){var a=this.props.validator;return!a.schema.hasOwnProperty("maxItems")||a.schema.maxItems>a.items.length?React.DOM.li({className:"json-form-row"},React.DOM.div({className:"json-form-control"},React.DOM.button({onClick:this.handleNewItem}," Add item "))):void 0},render:function(){return React.DOM.ol({className:"json-items"},this._items(),this._addItemButton())}}),JsonObject.prototype.view=React.createClass({handleRemoveProperty:function(a){delete this.props.validator.properties[a],this.props.onChange(this.props.validator)},handleChangeProperty:function(a,b){this.props.validator.properties[a]=b,this.props.onChange(this.props.validator)},handleAddProperty:function(a){{var b=this.props.validator.value();this.props.validator.schema}b[a]=void 0,this.props.validator.setData(b),this.props.onChange(this.props.validator)},handleNewProperty:function(){this.handleAddProperty(this.refs.additionalProperty.state.value)},_propertyTags:function(){var b=this.props.validator,c=b.schema;return c.properties?_.map(c.properties,function(c,d){var e,f;if(b.properties.hasOwnProperty(d)){var g=b.properties[d].view;e=g({validator:b.properties[d],onChange:this.handleChangeProperty.bind(this,d)}),b.required(d)||(f=this.handleRemoveProperty.bind(this,d))}else e=React.DOM.button({onClick:this.handleAddProperty.bind(this,d)}," Add property ");return a({property:d,label:c.title||d,onRemove:f},e)},this):void 0},_additionalProperties:function(){var b=this.props.validator,c=b.schema;return _.map(b.properties,function(b,d){if(!c.properties||!c.properties.hasOwnProperty(d)){var e=b.view;return a({label:d,property:d,onRemove:this.handleRemoveProperty.bind(this,d)},e({validator:b,onChange:this.handleChangeProperty.bind(this,d)}))}},this)},_addPropertyButton:function(){return this.props.validator.schema.additionalProperties?React.DOM.li({className:"json-form-row"},React.DOM.div({className:"json-form-control"},React.DOM.label(null,React.DOM.input({ref:"additionalProperty",type:"text"})),React.DOM.button({onClick:this.handleNewProperty}," Add property "))):void 0},render:function(){return React.DOM.ul({className:"json-properties"},this._propertyTags(),this._additionalProperties(),this._addPropertyButton())}});var a=React.createClass({displayName:"JsonFormRow",getInitialState:function(){return{collapsed:!0}},handleCollapse:function(){this.setState({collapsed:!0})},handleExpand:function(){this.setState({collapsed:!1})},_removeButton:function(){return this.props.onRemove?React.DOM.button({className:"glyphicon glyphicon-remove",onClick:this.props.onRemove}):void 0},_errorView:function(a){return a?React.DOM.span({className:"json-form-error"},a):void 0},_label:function(){return this.props.label?React.DOM.label(null,this.props.label):void 0},render:function(){var a=this.props.children,b=a.props.validator,c=b&&b.errors[0];return!b||b.inline?React.DOM.li({className:"json-form-row",key:this.props.property},React.DOM.div({className:"json-form-control"},this._label(),a," ",this._removeButton()," ",this._errorView(c))):this.state.collapsed?React.DOM.li({className:"json-form-row",key:this.props.property},React.DOM.div({className:"json-form-control collapser"},this._label(),React.DOM.button({className:"glyphicon glyphicon-expand",onClick:this.handleExpand})," ",this._removeButton()," ",this._errorView(c)),React.DOM.div({className:"collapsible collapsed"},a)):React.DOM.li({className:"json-form-row",key:this.props.property},React.DOM.div({className:"json-form-control collapser"},this._label(),React.DOM.button({className:"glyphicon glyphicon-collapse-down",onClick:this.handleCollapse})," ",this._removeButton()," ",this._errorView(c)),React.DOM.div({className:"collapsible"},a))}});JsonBoolean.prototype.view=React.createClass({handleChange:function(a){this.props.validator.setData(a.target.checked),this.props.onChange(this.props.validator)},render:function(){return React.DOM.input({onChange:this.handleChange,type:"checkbox",checked:this.props.validator.value()})}}),JsonNull.prototype.view=React.createClass({render:function(){return React.DOM.strong(null,"NULL")}});var b=React.createClass({displayName:"JsonForm",getInitialState:function(){return{validator:new JsonValidator(this.props.schema,this.props.data)}},handleChange:function(a){this.setState({validator:a})},value:function(){return this.state.validator.valid()?this.state.validator.value():void 0},render:function(){var a=this.state.validator.view;return React.DOM.div(null,a({validator:this.state.validator,onChange:this.handleChange}),React.DOM.p(null,JSON.stringify(this.value())))}});window.JsonForm=b}();